{% extends 'base.html' %}

{% load widget_tweaks %}
{% load static %}

{% block header %}
<header class="jumbotron jumbotron-fluid">
    <div class="container p-5">
        <h1 class="display-4 mb-3">タイムテーブル登録</h1>
        <p class="lead">試合のタイムテーブルを登録してください</p>
    </div>
</header>
{% endblock header %}

{% block content %}
<div class="container">
    <div class="suggestion">
        <form action="{% url 'shift:suggest' pk %}" method="POST" class="form-inline">{% csrf_token %}
            <label class="m-3">過去の試合データを参照</label>
            <select name="competition" class="form-control m-3">
                {% for s in suggest %}
                    <option value={{s.id}}>{{s.year}}{{s.name}}</option>
                {% endfor %}
            </select>
            <input type="submit" value="表示" class="form-control m-3">
        </form>
    </div>
    <form action="{% url 'shift:register' pk %}" method="post" id="form" data-length="{{ object_list|length }}">
    {% csrf_token %}
    {{ formset.management_form }}
        <table class="table mt-5" id="table">
            <thead>
                <tr>
                    <th>性別</th>
                    <th>距離</th>
                    <th>種目</th>
                    <th>開始時刻</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for item in object_list %}
                <tr class="form-row">
                {% for field in formset.form %}
                    <td>
                        {{field|add_class:"form-control"}}
                    </td>
                {% endfor %}
                </tr>
            {% endfor %}
            <tr class="form-empty">
                {% for field in formset.form %}
                    <td>
                        {{field|add_class:"form-control"}}
                    </td>
                {% endfor %}
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                    <div class="form-add" id="form_add">
                        <span class="add btn btn-info" title="Add">+</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                    <div>
                        <input type="submit" value="登録" class="form-control">
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </form>
</div>


{% endblock content %}

{% block script %}
<script>
    $(function () {
        $(document).on('click', 'span.add', function () {
            console.log("test");
            frm_emp = $(".form-empty").last();
            frm_nxt = frm_emp.clone();
            frm_nxt.insertAfter(frm_emp);
        })

        $('#form').submit(function() {  // フォームを送信する直前

            // フォームの入力欄の数を指定する
            const text = $('.form-row');
            $('[name=form-TOTAL_FORMS]').val(text.length+1);

            // それぞれの入力欄の__prefix__をindexで置換する
            text.each(function(index, element){
                html = $(element).html().replace(/__prefix__/g, index);
                value = $(element).find("input[type='text']").val();  // valueが消えるので保存しておく
                $(element).html(html);
                $(element).find("input[type='text']").val(value);
        });

    });
    })
    </script>
{% endblock script %}